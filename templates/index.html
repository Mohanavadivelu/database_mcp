<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Natural Language Console</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* Dark theme variables */
            --bg-primary: #1e1e1e;
            --bg-secondary: #000;
            --bg-tertiary: #333;
            --text-primary: #d4d4d4;
            --text-secondary: #9cdcfe;
            --text-accent: #569cd6;
            --text-success: #6a9955;
            --text-error: #f44747;
            --border-color: #333;
            --border-focus: #569cd6;
            --button-bg: #569cd6;
            --button-hover: #4a8ac9;
            --sidebar-bg: #252526;
        }

        [data-theme="light"] {
            /* Light theme variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f8f8;
            --bg-tertiary: #e8e8e8;
            --text-primary: #333333;
            --text-secondary: #0066cc;
            --text-accent: #0066cc;
            --text-success: #008000;
            --text-error: #cc0000;
            --border-color: #cccccc;
            --border-focus: #0066cc;
            --button-bg: #0066cc;
            --button-hover: #0052a3;
            --sidebar-bg: #f0f0f0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: var(--text-accent);
            margin: 0;
            font-size: 1.5em;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-toggle, .sidebar-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover, .sidebar-toggle:hover {
            background: var(--button-bg);
            color: white;
        }

        .sidebar-toggle.active {
            background: var(--button-bg);
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transform: translateX(0);
            transition: transform 0.3s ease;
            position: relative;
        }

        .sidebar.closed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            border-color: var(--border-focus);
            background: var(--bg-primary);
        }

        .history-item.favorite {
            border-left: 3px solid var(--text-success);
        }

        .history-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .history-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 5px;
            font-size: 0.8em;
        }

        .history-actions button:hover {
            color: var(--text-accent);
        }

        /* --- Console Area --- */
        .console-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #console {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: var(--bg-secondary);
            scroll-behavior: smooth;
            position: relative;
        }

        .log-entry {
            padding: 8px 0;
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
            position: relative;
        }

        .log-entry.with-actions {
            padding-right: 100px;
        }

        .log-actions {
            position: absolute;
            right: 0;
            top: 8px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .log-entry:hover .log-actions {
            opacity: 1;
        }

        .log-actions button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 3px;
        }

        .prompt::before {
            content: '> ';
            color: var(--text-success);
            font-weight: bold;
        }

        .response {
            color: var(--text-secondary);
        }

        .error {
            color: var(--text-error);
        }

        /* --- Loading Indicator --- */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            padding: 8px 0;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--text-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Input Form --- */
        .input-container {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-primary);
        }

        #input-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #command-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px;
            font-family: inherit;
            font-size: 1em;
            border-radius: 4px;
            transition: border-color 0.3s ease;
        }

        #command-input:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .input-actions {
            display: flex;
            gap: 5px;
        }

        button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 12px 16px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:hover:not(:disabled) {
            background-color: var(--button-hover);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .secondary-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .secondary-btn:hover:not(:disabled) {
            background-color: var(--border-color);
        }

        /* --- Chart Container --- */
        #chart-container {
            margin: 15px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            position: relative;
        }

        .chart-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }

            .header h1 {
                font-size: 1.2em;
            }

            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 200;
                width: 280px;
                transform: translateX(-100%);
            }

            .sidebar:not(.closed) {
                transform: translateX(0);
                box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            }

            #input-form {
                flex-direction: column;
                gap: 8px;
            }

            .input-actions {
                width: 100%;
                justify-content: space-between;
            }

            .input-actions button {
                flex: 1;
                padding: 10px;
                font-size: 0.9em;
            }

            .log-entry.with-actions {
                padding-right: 0;
            }

            .log-actions {
                position: static;
                margin-top: 5px;
                opacity: 1;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .header {
                padding: 8px 10px;
            }

            .sidebar {
                width: 100%;
            }

            #console {
                padding: 10px;
            }

            .input-container {
                padding: 10px;
            }
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body data-theme="dark">

    <!-- Header -->
    <div class="header">
        <h1><i class="fas fa-terminal"></i> MCP Natural Language Console</h1>
        <div class="header-controls">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-history"></i> History
            </button>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-sun"></i> <span id="theme-text">Light</span>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-history"></i> Query History</h3>
                <button class="secondary-btn" onclick="clearHistory()">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="sidebar-content" id="history-list">
                <!-- History items will be populated here -->
            </div>
        </div>

        <!-- Console Container -->
        <div class="console-container">
            <div id="console">
                <div class="log-entry response fade-in">Welcome! Ask a question about the usage data in plain English. Type 'help' for examples.</div>
            </div>

            <!-- Chart Container -->
            <div id="chart-container" class="hidden">
                <div class="chart-actions">
                    <button class="secondary-btn" onclick="exportChart('png')">
                        <i class="fas fa-download"></i> PNG
                    </button>
                    <button class="secondary-btn" onclick="exportData('csv')">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button class="secondary-btn" onclick="exportData('json')">
                        <i class="fas fa-file-code"></i> JSON
                    </button>
                </div>
                <canvas id="myChart"></canvas>
            </div>

            <!-- Input Container -->
            <div class="input-container">
                <form id="input-form">
                    <input type="text" id="command-input" placeholder="e.g., how many hours did alice spend on photoshop?" autocomplete="off" autofocus>
                    <div class="input-actions">
                        <button type="submit" id="send-btn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                        <button type="button" class="secondary-btn" onclick="clearConsole()">
                            <i class="fas fa-broom"></i> Clear
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let myChartInstance = null;
        let queryHistory = JSON.parse(localStorage.getItem('queryHistory') || '[]');
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let lastQueryData = null;
        let isLoading = false;

        // Get references to HTML elements
        const consoleDiv = document.getElementById('console');
        const form = document.getElementById('input-form');
        const input = document.getElementById('command-input');
        const sendBtn = document.getElementById('send-btn');
        const sidebar = document.getElementById('sidebar');
        const historyList = document.getElementById('history-list');
        const themeText = document.getElementById('theme-text');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            applyTheme(currentTheme);
            renderHistory();
            updateSidebarButtonState();
            
            // On mobile, start with sidebar closed
            if (window.innerWidth <= 768) {
                sidebar.classList.add('closed');
                updateSidebarButtonState();
            }
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && !sidebar.classList.contains('closed')) {
                    if (!sidebar.contains(e.target) && !e.target.closest('.sidebar-toggle')) {
                        sidebar.classList.add('closed');
                        updateSidebarButtonState();
                    }
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    // On desktop, always show sidebar
                    sidebar.classList.remove('closed');
                } else {
                    // On mobile, start closed if not already set
                    if (!sidebar.classList.contains('closed')) {
                        sidebar.classList.add('closed');
                    }
                }
                updateSidebarButtonState();
            });
        });

        /**
         * Handles the form submission event.
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = input.value.trim();
            if (!question || isLoading) return;

            addLog(question, 'prompt');
            addToHistory(question);
            input.value = '';

            const command = question.toLowerCase();

            // Handle built-in commands
            if (command === 'help') {
                const helpText =
                    "🤖 MCP Natural Language Console Help\n\n" +
                    "📊 Query Examples:\n" +
                    "  • How many hours did alice spend on photoshop?\n" +
                    "  • Show me all usage from bob\n" +
                    "  • What was the longest session in seconds?\n" +
                    "  • List all users on the windows platform\n" +
                    "  • What legacy apps were used?\n\n" +
                    "🔧 Built-in Commands:\n" +
                    "  • help: Show this help message\n" +
                    "  • clear: Clear the console screen\n\n" +
                    "💡 Features:\n" +
                    "  • Click History button to view past queries\n" +
                    "  • Toggle between light/dark themes\n" +
                    "  • Export chart data as PNG, CSV, or JSON\n" +
                    "  • Star queries to save as favorites";
                addLog(helpText, 'response');
            } else if (command === 'clear') {
                clearConsole();
            } else {
                await performLlmQuery(question);
            }
        });

        // Theme toggle functionality
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            const icon = document.querySelector('.theme-toggle i');
            if (theme === 'dark') {
                icon.className = 'fas fa-sun';
                themeText.textContent = 'Light';
            } else {
                icon.className = 'fas fa-moon';
                themeText.textContent = 'Dark';
            }
        }

        // Sidebar functionality
        function toggleSidebar() {
            sidebar.classList.toggle('closed');
            updateSidebarButtonState();
            
            // On mobile, close when clicking a history item
            if (window.innerWidth <= 768 && !sidebar.classList.contains('closed')) {
                // Auto-close after a delay if on mobile
                setTimeout(() => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.add('closed');
                        updateSidebarButtonState();
                    }
                }, 5000);
            }
        }
        
        function updateSidebarButtonState() {
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            const isOpen = !sidebar.classList.contains('closed');
            
            if (isOpen) {
                sidebarToggle.classList.add('active');
                sidebarToggle.innerHTML = '<i class="fas fa-history"></i> Hide History';
            } else {
                sidebarToggle.classList.remove('active');
                sidebarToggle.innerHTML = '<i class="fas fa-history"></i> Show History';
            }
        }

        // History management
        function addToHistory(query) {
            const historyItem = {
                id: Date.now(),
                query: query,
                timestamp: new Date().toISOString(),
                favorite: false
            };
            
            queryHistory.unshift(historyItem);
            if (queryHistory.length > 100) {
                queryHistory = queryHistory.slice(0, 100);
            }
            
            localStorage.setItem('queryHistory', JSON.stringify(queryHistory));
            renderHistory();
        }

        function renderHistory() {
            historyList.innerHTML = '';
            
            if (queryHistory.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No queries yet</div>';
                return;
            }

            queryHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${item.favorite ? 'favorite' : ''}`;
                historyItem.innerHTML = `
                    <div class="query-text">${item.query}</div>
                    <div class="history-actions">
                        <button onclick="toggleFavorite(${item.id})" title="${item.favorite ? 'Remove from favorites' : 'Add to favorites'}">
                            <i class="fas fa-star${item.favorite ? '' : '-o'}"></i>
                        </button>
                        <button onclick="rerunQuery('${item.query.replace(/'/g, "\\'")}')") title="Run again">
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick="removeFromHistory(${item.id})" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div style="font-size: 0.7em; color: var(--text-secondary); margin-top: 3px;">
                        ${new Date(item.timestamp).toLocaleString()}
                    </div>
                `;
                
                historyItem.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        input.value = item.query;
                        input.focus();
                        if (window.innerWidth <= 768) {
                            sidebar.classList.add('closed');
                            updateSidebarButtonState();
                        }
                    }
                });
                
                historyList.appendChild(historyItem);
            });
        }

        function toggleFavorite(id) {
            const item = queryHistory.find(q => q.id === id);
            if (item) {
                item.favorite = !item.favorite;
                localStorage.setItem('queryHistory', JSON.stringify(queryHistory));
                renderHistory();
            }
        }

        function rerunQuery(query) {
            input.value = query;
            form.dispatchEvent(new Event('submit'));
            if (window.innerWidth <= 768) {
                sidebar.classList.add('closed');
                updateSidebarButtonState();
            }
        }

        function removeFromHistory(id) {
            queryHistory = queryHistory.filter(q => q.id !== id);
            localStorage.setItem('queryHistory', JSON.stringify(queryHistory));
            renderHistory();
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all query history?')) {
                queryHistory = [];
                localStorage.removeItem('queryHistory');
                renderHistory();
            }
        }

        function clearConsole() {
            consoleDiv.innerHTML = '';
            document.getElementById('chart-container').classList.add('hidden');
        }

        /**
         * Adds a new message to the console log with enhanced features.
         * @param {string} message - The text to display.
         * @param {string} type - The class name for styling ('prompt', 'response', or 'error').
         * @param {boolean} withActions - Whether to add action buttons.
         * @returns {HTMLElement} The new log element created.
         */
        function addLog(message, type, withActions = false) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type} fade-in ${withActions ? 'with-actions' : ''}`;
            logEntry.textContent = message;
            
            if (withActions && type === 'response') {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'log-actions';
                actionsDiv.innerHTML = `
                    <button onclick="copyToClipboard(this)" title="Copy to clipboard">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button onclick="shareResponse(this)" title="Share">
                        <i class="fas fa-share"></i>
                    </button>
                `;
                logEntry.appendChild(actionsDiv);
            }
            
            consoleDiv.appendChild(logEntry);
            scrollToBottom();
            return logEntry;
        }

        /**
         * Creates and shows a loading indicator.
         */
        function showLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-indicator fade-in';
            loadingDiv.innerHTML = `
                <div class="spinner"></div>
                <span>Processing your query...</span>
            `;
            loadingDiv.id = 'loading-indicator';
            consoleDiv.appendChild(loadingDiv);
            scrollToBottom();
            return loadingDiv;
        }

        /**
         * Removes the loading indicator.
         */
        function hideLoadingIndicator() {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        /**
         * Copy text to clipboard functionality.
         */
        function copyToClipboard(button) {
            const logEntry = button.closest('.log-entry');
            const text = logEntry.textContent.replace(/CopyShare$/, '').trim();
            navigator.clipboard.writeText(text).then(() => {
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        /**
         * Share response functionality.
         */
        function shareResponse(button) {
            const logEntry = button.closest('.log-entry');
            const text = logEntry.textContent.replace(/CopyShare$/, '').trim();
            if (navigator.share) {
                navigator.share({
                    title: 'MCP Query Result',
                    text: text
                });
            } else {
                copyToClipboard(button);
            }
        }

        /**
         * Sends the user's question to the backend and displays the answer with enhanced UX.
         * @param {string} question - The user's natural language question.
         */
        async function performLlmQuery(question) {
            if (isLoading) return;
            
            isLoading = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            const loadingIndicator = showLoadingIndicator();
            const chartContainer = document.getElementById('chart-container');
            
            try {
                const response = await fetch('/api/llm_query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question }),
                });

                const data = await response.json();
                hideLoadingIndicator();

                if (response.ok) {
                    // Store the data for export functionality
                    lastQueryData = {
                        question: question,
                        answer: data.answer,
                        data: data.data,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Display the answer with action buttons
                    addLog(data.answer, 'response', true);

                    // Render chart if data is available
                    if (data.data && data.data.length > 0) {
                        try {
                            renderChart(data.data, data.question);
                            chartContainer.classList.remove('hidden');
                        } catch (chartError) {
                            console.error("Error rendering chart:", chartError);
                            addLog(`⚠️ Chart rendering failed: ${chartError.message}`, 'error');
                            chartContainer.classList.add('hidden');
                        }
                    } else {
                        chartContainer.classList.add('hidden');
                    }

                } else {
                    // Handle API errors
                    const errorMessage = data.answer || data.error || 'Unknown server error';
                    addLog(`🚨 Server Error: ${errorMessage}`, 'error');
                    chartContainer.classList.add('hidden');
                }

            } catch (error) {
                hideLoadingIndicator();
                // Handle network errors
                addLog(`🔌 Connection Error: ${error.message}\n\nPlease check your internet connection and try again.`, 'error');
                chartContainer.classList.add('hidden');
            } finally {
                isLoading = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
                scrollToBottom();
            }
        }

        // Export functionality
        function exportChart(format) {
            if (!myChartInstance) {
                addLog('❌ No chart available to export', 'error');
                return;
            }
            
            try {
                const canvas = myChartInstance.canvas;
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `chart-${Date.now()}.png`;
                link.href = url;
                link.click();
                
                addLog('✅ Chart exported successfully', 'response');
            } catch (error) {
                addLog(`❌ Export failed: ${error.message}`, 'error');
            }
        }

        function exportData(format) {
            if (!lastQueryData || !lastQueryData.data) {
                addLog('❌ No data available to export', 'error');
                return;
            }
            
            try {
                let content, filename, mimeType;
                
                if (format === 'csv') {
                    content = convertToCSV(lastQueryData.data);
                    filename = `query-results-${Date.now()}.csv`;
                    mimeType = 'text/csv';
                } else if (format === 'json') {
                    content = JSON.stringify({
                        query: lastQueryData.question,
                        timestamp: lastQueryData.timestamp,
                        results: lastQueryData.data
                    }, null, 2);
                    filename = `query-results-${Date.now()}.json`;
                    mimeType = 'application/json';
                }
                
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
                
                addLog(`✅ Data exported as ${format.toUpperCase()} successfully`, 'response');
            } catch (error) {
                addLog(`❌ Export failed: ${error.message}`, 'error');
            }
        }

        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header];
                        // Escape quotes and wrap in quotes if contains comma or quote
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }

        /**
         * Renders a chart based on the provided data and inferred chart type.
         * @param {Array<Object>} data - The raw data from the database.
         * @param {string} question - The original user question.
         */
        function renderChart(data, question) {
            // Destroy existing chart if it exists
            if (myChartInstance) {
                myChartInstance.destroy();
            }

            const ctx = document.getElementById('myChart').getContext('2d');
            let chartConfig;

            // Simple heuristics to determine chart type based on data structure and question
            const keys = Object.keys(data[0]);
            const isAggregation = keys.includes('result') && keys.length === 2; // e.g., user, result or app, result

            if (isAggregation) {
                // Bar chart for aggregates like counts or sums per category
                const labels = data.map(item => Object.values(item)[0]); // First key is category (user, app, etc.)
                const values = data.map(item => item.result);

                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Result',
                            data: values,
                            backgroundColor: '#569cd6',
                            borderColor: '#333',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: question || 'Query Result',
                                color: '#d4d4d4'
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#d4d4d4' },
                                grid: { color: '#333' }
                            },
                            y: {
                                ticks: { color: '#d4d4d4' },
                                grid: { color: '#333' }
                            }
                        }
                    }
                };
            } else if (keys.includes('log_date') && keys.includes('duration_seconds')) {
                // Line chart for time-series data
                // This would require more sophisticated grouping/aggregation in JS if not already done by SQL
                // For simplicity, let's just show a basic bar for now, or adapt if the SQL gives daily aggregation
                 const labels = data.map(item => new Date(item.log_date).toLocaleDateString());
                 const values = data.map(item => item.duration_seconds);

                 chartConfig = {
                     type: 'line', // Line chart for time series
                     data: {
                         labels: labels,
                         datasets: [{
                             label: 'Duration (seconds)',
                             data: values,
                             borderColor: '#6a9955',
                             backgroundColor: 'rgba(106, 153, 85, 0.2)',
                             borderWidth: 2,
                             fill: true,
                             tension: 0.1
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 display: true,
                                 labels: { color: '#d4d4d4' }
                             },
                             title: {
                                 display: true,
                                 text: question || 'Query Result',
                                 color: '#d4d4d4'
                             }
                         },
                         scales: {
                             x: {
                                 ticks: { color: '#d4d4d4' },
                                 grid: { color: '#333' }
                             },
                             y: {
                                 ticks: { color: '#d4d4d4' },
                                 grid: { color: '#333' }
                             }
                         }
                     }
                 };

            } else {
                // Default to a table or general bar chart if no specific pattern
                console.warn("Could not infer specific chart type. Displaying raw data as text.");
                // Optionally display the raw data in a more readable format if no chart
                document.getElementById('chart-container').style.display = 'none';
                addLog('Raw Data (click to inspect in console):', 'response');
                addLog(JSON.stringify(data, null, 2), 'response');
                return; // Do not create a chart instance
            }

            myChartInstance = new Chart(ctx, chartConfig);
        }

        /**
         * Automatically scrolls the console to the bottom.
         */
        function scrollToBottom() {
            setTimeout(() => { // Use a timeout to ensure DOM update is complete
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }, 100);
        }

    </script>

</body>
</html>
